<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AI Subway Train Scheduler</title>
  <style>
    body { margin:0; background:#0b1220; color:white; font-family:Arial; }
    #app { display:flex; height:100vh; }
    #map { flex:1; position:relative; }
    svg { width:100%; height:100%; background: linear-gradient(#081018,#0b1220); }
    #optimalPathBig {
      padding:30px 0;
      text-align:center;
      font-size:2.6em;
      color:#fbbf24;
      font-weight:bold;
      min-height:2.7em;
      letter-spacing:2px;
    }
    #panel { width:340px; padding:16px; background:#111827; overflow:auto; }
    select, input, button { width:100%; margin:4px 0; padding:6px; font-size:1em; }
    .station-label { font-size:13px; fill:#fff; font-weight:bold; pointer-events:none; }
    #trainStatus { margin:12px 0; padding:7px 0; font-size:1.1em; color:#93c5fd; }
    #log { font-size:12px; max-height:180px; overflow:auto; background:rgba(0,0,0,0.1); margin-top:10px;}
    @media (max-width:900px){ #app{ flex-direction:column;} #panel{width:100%;height:auto;} #map{height:350px;} }
  </style>
</head>
<body>
  <div id="app">
    <div id="map" style="display:flex;flex-direction:column;">
      <svg id="svgmap" viewBox="0 0 800 600"></svg>
      <div id="optimalPathBig"></div>
    </div>
    <div id="panel">
      <h3>AI Train Scheduler</h3>
      <div>
        <label>Source Station:</label>
        <select id="srcSelect"></select>
        <label>Destination Station:</label>
        <select id="dstSelect"></select>
        <button id="scheduleBtn">ðŸš‚ Schedule Train</button>
      </div>
      <hr/>
      <strong>Status</strong>
      <div id="trainStatus">No train scheduled</div>
      <div id="log"></div>
    </div>
  </div>

<script>
const svg = document.getElementById("svgmap");
const optimalPathBig = document.getElementById("optimalPathBig");
const log = document.getElementById("log");
const statusDiv = document.getElementById("trainStatus");

let nodes = {}, edges = [], train = null, stationsList = [];

// 15 stations with coordinates
const STATION_COORDS = {
  "S1": [100, 100],  "S2": [260, 60],  "S3": [420, 80],
  "S4": [600, 100],  "S5": [680, 250], "S6": [620, 400],
  "S7": [400, 360],  "S8": [230, 350], "S9": [110, 250],
  "S10": [330, 180], "S11": [520, 250], "S12": [550, 350],
  "S13": [720, 320], "S14": [140, 170], "S15": [700, 450]
};
// Edges defining routes
const STATION_EDGES = [
  ["S1","S2"], ["S2","S3"], ["S3","S4"], ["S4","S5"],
  ["S5","S6"], ["S6","S7"], ["S7","S8"], ["S8","S9"], ["S9","S1"],
  ["S3","S10"], ["S10","S7"], ["S2","S10"], ["S10","S8"],
  ["S5","S11"], ["S11","S12"], ["S12","S6"], ["S11","S13"],
  ["S9","S14"], ["S13","S15"], ["S6","S15"]
];

function drawGraph(){
  svg.innerHTML = "";
  edges.forEach(e=>{
    const u=nodes[e.u], v=nodes[e.v];
    const line=document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1",u.pos[0]); line.setAttribute("y1",u.pos[1]);
    line.setAttribute("x2",v.pos[0]); line.setAttribute("y2",v.pos[1]);
    line.setAttribute("stroke","#6ee7b7"); line.setAttribute("stroke-width","7");
    svg.appendChild(line);
  });
  for(const k in nodes){
    const n=nodes[k];
    const circle=document.createElementNS("http://www.w3.org/2000/svg","circle");
    circle.setAttribute("cx",n.pos[0]); circle.setAttribute("cy",n.pos[1]);
    circle.setAttribute("r",12); circle.setAttribute("fill","#fbbf24");
    svg.appendChild(circle);
    const text=document.createElementNS("http://www.w3.org/2000/svg","text");
    text.setAttribute("x",n.pos[0]+16); text.setAttribute("y",n.pos[1]+5);
    text.setAttribute("class","station-label"); text.textContent=k;
    svg.appendChild(text);
  }
  const trainsLayer=document.createElementNS("http://www.w3.org/2000/svg","g");
  trainsLayer.setAttribute("id","trainsLayer"); svg.appendChild(trainsLayer);
}

function updateTrainUI(){
  const layer=document.getElementById("trainsLayer");
  if(!layer) return; layer.innerHTML="";
  edges.forEach(e=>{
    svg.querySelectorAll('line').forEach(line => line.setAttribute("stroke","#6ee7b7"));
  });
  if(train && train.path){
    const pos=train.position || (train.path && nodes[train.path[0]] ? nodes[train.path[0]].pos : [0,0]);
    const g=document.createElementNS("http://www.w3.org/2000/svg","g");
    const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx",pos[0]); c.setAttribute("cy",pos[1]); c.setAttribute("r",10);
    c.setAttribute("fill", train.status && train.status.includes("waiting") ? "#fde68a" : "#60a5fa");
    g.appendChild(c);
    if(train.path){
      for(let i=0;i<train.path.length-1;i++){
        svg.querySelectorAll('line').forEach(line => {
          const [x1,y1] = nodes[train.path[i]].pos, [x2,y2] = nodes[train.path[i+1]].pos;
          if(
            (line.getAttribute("x1")==x1 && line.getAttribute("y1")==y1 &&
             line.getAttribute("x2")==x2 && line.getAttribute("y2")==y2) ||
            (line.getAttribute("x1")==x2 && line.getAttribute("y1")==y2 &&
             line.getAttribute("x2")==x1 && line.getAttribute("y2")==y1)
          ) line.setAttribute("stroke","#ef4444");
        });
      }
    }
    g.innerHTML+=`<text x="${pos[0]+10}" y="${pos[1]+4}" fill="#fff" font-size="15">ðŸš‹</text>`;
    layer.appendChild(g);
    statusDiv.textContent = `${train.id ? "Train "+train.id : "Train"}: ${train.status||"?"}`;
  } else {
    statusDiv.textContent = "No train scheduled";
  }
}

function logMsg(s){
  const d = document.createElement("div");
  d.textContent = `[${new Date().toLocaleTimeString()}] ${s}`;
  log.prepend(d);
}

function loadGraph(){
  nodes = {};
  Object.entries(STATION_COORDS).forEach(([k,v])=>{ nodes[k]={pos:v}; });
  edges = STATION_EDGES.map(e=>({u:e[0],v:e[1]}));
  stationsList = Object.keys(STATION_COORDS);
  const srcSel=document.getElementById("srcSelect"), dstSel=document.getElementById("dstSelect");
  srcSel.innerHTML=""; dstSel.innerHTML="";
  stationsList.forEach(k=>{
    srcSel.innerHTML+=`<option value="${k}">${k}</option>`;
    dstSel.innerHTML+=`<option value="${k}">${k}</option>`;
  });
  drawGraph();
}

document.getElementById("scheduleBtn").addEventListener("click", async ()=>{
  optimalPathBig.textContent="";
  train=null; updateTrainUI();
  logMsg("Scheduling...");
  const src=document.getElementById("srcSelect").value;
  const dst=document.getElementById("dstSelect").value;
  if(src==dst){
    logMsg("Source and destination cannot be same.");
    optimalPathBig.textContent = "Pick different stations!";
    return;
  }
  try{
    const res=await fetch("http://localhost:8000/schedule_train",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({source:src,destination:dst})
    });
    const j=await res.json();
    if(j.ok){
      logMsg(`Scheduled train ${j.train_id}, path: ${j.path.join(" â†’ ")}`);
      optimalPathBig.textContent="Optimal Path: " + j.path.join(" â†’ ");
      setTimeout(()=>optimalPathBig.textContent="",35000);
    } else {
      logMsg("Schedule failed: "+ (j.error||"Unknown"));
      optimalPathBig.textContent = "";
    }
  }catch(e){
    logMsg("Schedule request failed: " + e.message);
    optimalPathBig.textContent = "";
  }
});

function startWS(){
  const ws=new WebSocket("ws://localhost:8000/ws");
  ws.onopen=()=>{ logMsg("WS connected"); };
  ws.onmessage=(ev)=>{
    try{
      const d=JSON.parse(ev.data);
      if(d.type==="train_update" && d.train){
        train = d.train;
        updateTrainUI();
      }
    }catch(e){ console.error(e); }
  };
  ws.onclose=()=>{ logMsg("WS closed - reconnecting..."); setTimeout(startWS,1800); };
  ws.onerror=(e)=>{ console.error("WS error", e);}
}

loadGraph();
updateTrainUI();
startWS();
</script>
</body>
</html>
